<?php

use EFrane\PharTest\Application\PharApplication;
use EFrane\PharTest\Application\PharKernel;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Dotenv\Dotenv;

if (!in_array(PHP_SAPI, ['cli', 'phpdbg', 'embed'], true)) {
    echo 'Warning: The console should be invoked via the CLI version of PHP, not the '.PHP_SAPI.' SAPI'.PHP_EOL;
}

set_time_limit(0);

require dirname(__DIR__).'/vendor/autoload.php';

$input = new ArgvInput();

$workingDirectory = $input->getParameterOption(['--cwd', '-C'], getcwd(), true);

if (is_dir($workingDirectory)) {
    chdir($workingDirectory);
} else {
    echo 'Error: Requested working directory '.$workingDirectory.' does not exist'.PHP_EOL;
    return 1;
}

putenv('APP_ENV=prod');
putenv('APP_DEBUG=0');

(new Dotenv())->bootEnv(dirname(__DIR__).'/.env');

$kernel = new PharKernel('prod', false);
$application = new PharApplication($kernel);

try {
    $application->run($input);
} catch (Exception $e) {
    return 1;
}
